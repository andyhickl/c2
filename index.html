<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>C2 Workout Tracker</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            margin: 0;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .header {
            padding: 20px;
            border-bottom: 1px solid #eee;
            background: #2c3e50;
            color: white;
            border-radius: 8px 8px 0 0;
        }
        .data-source-selector {
            padding: 20px;
            background: #ecf0f1;
            border-bottom: 1px solid #bdc3c7;
        }
        .data-source-option {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            padding: 15px;
            background: white;
            border-radius: 6px;
            border: 2px solid #ddd;
            cursor: pointer;
            transition: all 0.3s;
        }
        .data-source-option:hover {
            border-color: #3498db;
        }
        .data-source-option.selected {
            border-color: #3498db;
            background: #ebf3fd;
        }
        .data-source-option input[type="radio"] {
            margin-right: 10px;
        }
        .file-upload {
            margin: 15px 0;
        }
        .file-input {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: white;
        }
        .upload-button {
            background: #27ae60;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin-left: 10px;
        }
        .upload-button:hover {
            background: #229954;
        }
        .upload-button:disabled {
            background: #95a5a6;
            cursor: not-allowed;
        }
        .tabs {
            display: flex;
            border-bottom: 1px solid #eee;
        }
        .tab {
            padding: 15px 25px;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 16px;
            color: #666;
        }
        .tab.active {
            background: #3498db;
            color: white;
        }
        .content {
            padding: 20px;
        }
        .auth-section {
            text-align: center;
            padding: 40px;
        }
        .auth-button {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
        }
        .auth-button:hover {
            background: #c0392b;
        }
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            background: #ddd;
            border: 1px solid #ddd;
        }
        .calendar-day {
            background: white;
            min-height: 100px;
            padding: 8px;
            position: relative;
        }
        .calendar-day-number {
            font-weight: bold;
            margin-bottom: 5px;
        }
        .workout-circle {
            position: absolute;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: bold;
            color: white;
            text-shadow: 1px 1px 1px rgba(0,0,0,0.5);
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .stats-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid #3498db;
        }
        .stats-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
            color: #2c3e50;
        }
        .stats-value {
            font-size: 24px;
            font-weight: bold;
            color: #e74c3c;
            margin-bottom: 5px;
        }
        .stats-label {
            color: #666;
            font-size: 14px;
        }
        .calendar-legend {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
            border: 1px solid #dee2e6;
        }
        .legend-row {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        .legend-title {
            font-weight: bold;
            margin-bottom: 10px;
            color: #2c3e50;
        }
        .legend-circles {
            display: flex;
            gap: 15px;
            margin-left: 10px;
        }
        .legend-circle {
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            text-shadow: 1px 1px 1px rgba(0,0,0,0.5);
        }
        .legend-colors {
            display: flex;
            gap: 10px;
            margin-left: 10px;
        }
        .legend-color {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .legend-color-box {
            width: 20px;
            height: 20px;
            border-radius: 50%;
        }
        .calendar-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .nav-button {
            background: #3498db;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
        }
        .nav-button:hover {
            background: #2980b9;
        }
        .nav-button:disabled {
            background: #95a5a6;
            cursor: not-allowed;
        }
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 6px;
            margin: 20px 0;
        }
        .success {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 6px;
            margin: 20px 0;
        }
        .data-info {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
        }
        .ftp-settings {
            background: #fff3cd;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
        }
        .ftp-input {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            width: 100px;
            margin: 0 10px;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // Configuration
        const CONFIG = {
            CLIENT_ID: 'EourZV4an5ms0stQVwphmaZao96UV5jZMpAWH67K',
            CLIENT_SECRET: 'Fh6Lr8R61UDAnrYoB90cf1fZkILgjnbfQjCd6Dfd',
            REDIRECT_URI: 'https://andyhickl.github.io/c2/',
            BASE_URL: 'https://log-dev.concept2.com',
            SCOPES: 'user:read,results:read'
        };

        // Utility functions
        function formatTime(seconds) {
            if (!seconds || seconds === 0) return '0:00';
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = Math.floor(seconds % 60);
            if (hours > 0) {
                return `${hours}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
            }
            return `${minutes}:${secs.toString().padStart(2, '0')}`;
        }

        function formatPace(pace) {
            if (!pace || pace === 0) return '0:00';
            const minutes = Math.floor(pace / 60);
            const seconds = Math.floor(pace % 60);
            return `${minutes}:${seconds.toString().padStart(2, '0')}`;
        }

        function parseTime(timeString) {
            if (!timeString) return 0;
            const parts = timeString.split(':').map(p => parseInt(p) || 0);
            if (parts.length === 3) {
                return parts[0] * 3600 + parts[1] * 60 + parts[2];
            } else if (parts.length === 2) {
                return parts[0] * 60 + parts[1];
            }
            return parseInt(timeString) || 0;
        }

        // TSS and IF calculations
        function calculateTSS(workout, userFTP = 166, thresholdMethod = 'watts', thresholdPace = '2:34') {
            const duration = workout.time || 0;
            const distance = workout.distance || 0;
            
            if (duration === 0) return 0;
            
            let watts = workout.watts || 0;
            let effectiveFTP = userFTP;
            
            // If using pace method, use speed-based calculation (more accurate)
            if (thresholdMethod === 'pace') {
                const thresholdSeconds = parseTime(thresholdPace);
                const workoutPaceSeconds = duration / (distance / 500); // pace per 500m
                
                if (thresholdSeconds <= 0 || workoutPaceSeconds <= 0) return 0;
                
                // Calculate IF using speed ratio (ChatGPT's method)
                const thresholdSpeed = 500 / thresholdSeconds; // m/s
                const workoutSpeed = 500 / workoutPaceSeconds; // m/s
                const intensityFactor = Math.min(workoutSpeed / thresholdSpeed, 2.0); // cap at 2.0
                
                const tss = (duration / 3600) * intensityFactor * intensityFactor * 100;
                return Math.round(tss);
            }
            
            // Power-based method for when we have actual watts or using FTP
            if (thresholdMethod === 'watts') {
                effectiveFTP = userFTP;
            }
            
            // If we don't have watts, estimate from pace using power curve
            if (watts === 0) {
                const avgPaceSeconds = duration / (distance / 500);
                if (avgPaceSeconds <= 0) return 0;
                const avgPaceMinutes = avgPaceSeconds / 60;
                watts = Math.max(50, 2800 / Math.pow(avgPaceMinutes, 3));
            }
            
            const intensityFactor = watts / effectiveFTP;
            const tss = (duration / 3600) * intensityFactor * intensityFactor * 100;
            
            return Math.round(tss);
        }

        function calculateIF(workout, userFTP = 166, thresholdMethod = 'watts', thresholdPace = '2:34') {
            const duration = workout.time || 0;
            const distance = workout.distance || 0;
            
            if (duration === 0) return 0;
            
            let watts = workout.watts || 0;
            let effectiveFTP = userFTP;
            
            // If using pace method, use speed-based calculation
            if (thresholdMethod === 'pace') {
                const thresholdSeconds = parseTime(thresholdPace);
                const workoutPaceSeconds = duration / (distance / 500);
                
                if (thresholdSeconds <= 0 || workoutPaceSeconds <= 0) return 0;
                
                const thresholdSpeed = 500 / thresholdSeconds;
                const workoutSpeed = 500 / workoutPaceSeconds;
                return Math.round((Math.min(workoutSpeed / thresholdSpeed, 2.0)) * 100) / 100;
            }
            
            // Power-based method
            if (thresholdMethod === 'watts') {
                effectiveFTP = userFTP;
            }
            
            if (watts === 0) {
                const avgPaceSeconds = duration / (distance / 500);
                if (avgPaceSeconds <= 0) return 0;
                const avgPaceMinutes = avgPaceSeconds / 60;
                watts = Math.max(50, 2800 / Math.pow(avgPaceMinutes, 3));
            }
            
            return Math.round((watts / effectiveFTP) * 100) / 100;
        }

        // Function to combine multiple workouts on the same day
        function combineWorkoutsForDay(workouts) {
            const totalDistance = workouts.reduce((sum, w) => sum + (w.distance || 0), 0);
            const totalTime = workouts.reduce((sum, w) => sum + (w.time || 0), 0);
            const totalWatts = workouts.reduce((sum, w) => sum + ((w.watts || 0) * (w.time || 0)), 0);
            const avgWatts = totalTime > 0 ? totalWatts / totalTime : 0;
            
            return {
                date: workouts[0].date,
                time: totalTime,
                distance: totalDistance,
                watts: avgWatts,
                workoutCount: workouts.length
            };
        }

        // Color mapping for IF values
        function getIFColor(ifValue) {
            if (ifValue < 0.5) return '#3498db'; // Blue - easy
            if (ifValue < 0.7) return '#2ecc71'; // Green - moderate
            if (ifValue < 0.85) return '#f39c12'; // Orange - hard
            if (ifValue < 1.0) return '#e67e22'; // Dark orange - very hard
            return '#e74c3c'; // Red - maximum
        }

        // CSV parsing function
        function parseCSV(csvText) {
            return new Promise((resolve, reject) => {
                Papa.parse(csvText, {
                    header: true,
                    dynamicTyping: true,
                    skipEmptyLines: true,
                    complete: function(results) {
                        if (results.errors.length > 0) {
                            console.warn('CSV parsing warnings:', results.errors);
                        }
                        
                        console.log('CSV Headers:', results.meta.fields);
                        console.log('Sample row:', results.data[0]);
                        
                        // Transform CSV data to our format - updated for C2 export format
                        const workouts = results.data.map(row => {
                            // Map C2 export fields to our format
                            const date = row.Date;
                            const time = row['Work Time (Seconds)'] || 0;
                            const distance = row['Work Distance'] || 0;
                            const pace = row.Pace;
                            const watts = row['Avg Watts'] || 0;
                            
                            // Convert pace string to seconds if needed
                            let paceSeconds = 0;
                            if (pace && typeof pace === 'string') {
                                paceSeconds = parseTime(pace);
                            }
                            
                            return {
                                date: date ? new Date(date).toISOString() : new Date().toISOString(),
                                time: time,
                                distance: distance,
                                pace: paceSeconds,
                                watts: watts,
                                type: row.Type || 'Unknown',
                                strokeRate: row['Stroke Rate/Cadence'] || 0,
                                heartRate: row['Avg Heart Rate'] || 0,
                                description: row.Description || '',
                                strokeCount: row['Stroke Count'] || 0
                            };
                        }).filter(w => {
                            const hasValidData = (w.time > 0 || w.distance > 0) && w.date;
                            if (!hasValidData) {
                                console.log('Filtered out row:', w);
                            }
                            return hasValidData;
                        });
                        
                        console.log(`Processed ${workouts.length} workouts from ${results.data.length} rows`);
                        resolve(workouts);
                    },
                    error: function(error) {
                        reject(error);
                    }
                });
            });
        }

        // Authentication functions
        function getAuthUrl() {
            const params = new URLSearchParams({
                client_id: CONFIG.CLIENT_ID,
                response_type: 'code',
                redirect_uri: CONFIG.REDIRECT_URI,
                scope: CONFIG.SCOPES
            });
            return `${CONFIG.BASE_URL}/oauth/authorize?${params}`;
        }

        async function exchangeCodeForToken(code) {
            try {
                console.log('Exchanging code for token...', code);
                
                // Try multiple possible token endpoints
                const endpoints = [
                    '/token',
                    '/access_token', 
                    '/oauth/access_token',
                    '/api/token',
                    '/oauth/token',
                    '/api/oauth/token'
                ];
                
                let lastError = null;
                
                for (const endpoint of endpoints) {
                    try {
                        console.log(`Trying endpoint: ${endpoint}`);
                        const response = await fetch(`${CONFIG.BASE_URL}${endpoint}`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/x-www-form-urlencoded',
                            },
                            body: new URLSearchParams({
                                grant_type: 'authorization_code',
                                client_id: CONFIG.CLIENT_ID,
                                client_secret: CONFIG.CLIENT_SECRET,
                                code: code,
                                redirect_uri: CONFIG.REDIRECT_URI
                            })
                        });
                        
                        console.log(`${endpoint} response status:`, response.status);
                        
                        if (response.ok) {
                            const data = await response.json();
                            console.log('Token exchange successful with endpoint:', endpoint, data);
                            return data.access_token;
                        } else {
                            const errorText = await response.text();
                            console.log(`${endpoint} failed:`, response.status, errorText.substring(0, 200));
                            lastError = `${endpoint}: ${response.status}`;
                        }
                    } catch (err) {
                        console.log(`${endpoint} error:`, err.message);
                        lastError = `${endpoint}: ${err.message}`;
                    }
                }
                
                throw new Error(`All token endpoints failed. Last error: ${lastError}`);
                
            } catch (error) {
                console.error('Token exchange error:', error);
                throw error;
            }
        }

        async function fetchWorkouts(accessToken) {
            try {
                console.log('Fetching workouts with token:', accessToken.substring(0, 10) + '...');
                const response = await fetch(`${CONFIG.BASE_URL}/api/users/me/results`, {
                    headers: {
                        'Authorization': `Bearer ${accessToken}`,
                        'Accept': 'application/json'
                    }
                });
                
                console.log('Workouts response status:', response.status);
                console.log('Workouts response headers:', [...response.headers.entries()]);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Failed to fetch workouts:', response.status, errorText);
                    throw new Error(`Failed to fetch workouts: ${response.status} - ${errorText}`);
                }
                
                const data = await response.json();
                console.log('Workouts data:', data);
                return data.data || data.results || data || [];
            } catch (error) {
                console.error('Fetch workouts error:', error);
                throw error;
            }
        }

        // Data Source Selector Component
        function DataSourceSelector({ onDataLoaded, onFTPChange, userFTP, onThresholdMethodChange, thresholdMethod, onThresholdPaceChange, thresholdPace }) {
            const [dataSource, setDataSource] = useState('csv');
            const [selectedFile, setSelectedFile] = useState(null);
            const [loading, setLoading] = useState(false);
            const [message, setMessage] = useState('');
            const [accessToken, setAccessToken] = useState(null);

            useEffect(() => {
                // Check for authorization code in URL
                const urlParams = new URLSearchParams(window.location.search);
                const code = urlParams.get('code');
                
                if (code && !accessToken) {
                    handleAuthCode(code);
                }
            }, []);

            async function handleAuthCode(code) {
                setLoading(true);
                setMessage('');
                
                try {
                    const token = await exchangeCodeForToken(code);
                    setAccessToken(token);
                    
                    // Clean up URL
                    window.history.replaceState({}, document.title, window.location.pathname);
                    
                    // Fetch workouts
                    const workoutData = await fetchWorkouts(token);
                    onDataLoaded(workoutData, 'API');
                    setMessage(`Successfully loaded ${workoutData.length} workouts from API`);
                } catch (err) {
                    setMessage('Failed to authenticate or fetch data: ' + err.message);
                } finally {
                    setLoading(false);
                }
            }

            async function handleFileUpload() {
                if (!selectedFile) return;
                
                setLoading(true);
                setMessage('');
                
                try {
                    const text = await selectedFile.text();
                    const workouts = await parseCSV(text);
                    onDataLoaded(workouts, 'CSV');
                    setMessage(`Successfully loaded ${workouts.length} workouts from CSV`);
                } catch (error) {
                    setMessage('Error parsing CSV: ' + error.message);
                } finally {
                    setLoading(false);
                }
            }

            return (
                <div className="data-source-selector">
                    <h3>Choose Data Source</h3>
                    
                    <div className="ftp-settings">
                        <label>
                            <input 
                                type="radio" 
                                name="threshold-method"
                                checked={thresholdMethod === 'watts'}
                                onChange={() => onThresholdMethodChange('watts')}
                            />
                            FTP (Functional Threshold Power):
                            <input 
                                type="number" 
                                value={userFTP} 
                                onChange={(e) => onFTPChange(parseInt(e.target.value) || 166)}
                                className="ftp-input"
                                disabled={thresholdMethod !== 'watts'}
                            />
                            watts
                        </label>
                        <br/>
                        <label style={{marginTop: '10px', display: 'block'}}>
                            <input 
                                type="radio" 
                                name="threshold-method"
                                checked={thresholdMethod === 'pace'}
                                onChange={() => onThresholdMethodChange('pace')}
                            />
                            Threshold 500m Pace:
                            <input 
                                type="text" 
                                value={thresholdPace} 
                                onChange={(e) => onThresholdPaceChange(e.target.value)}
                                className="ftp-input"
                                placeholder="2:34"
                                disabled={thresholdMethod !== 'pace'}
                            />
                            (MM:SS format)
                        </label>
                    </div>
                    
                    <div 
                        className={`data-source-option ${dataSource === 'csv' ? 'selected' : ''}`}
                        onClick={() => setDataSource('csv')}
                    >
                        <input 
                            type="radio" 
                            checked={dataSource === 'csv'} 
                            onChange={() => setDataSource('csv')}
                        />
                        <div>
                            <strong>Upload CSV File</strong>
                            <div>Export your workout data from log.concept2.com and upload it here</div>
                            {dataSource === 'csv' && (
                                <div className="file-upload">
                                    <input 
                                        type="file" 
                                        accept=".csv" 
                                        onChange={(e) => setSelectedFile(e.target.files[0])}
                                        className="file-input"
                                    />
                                    <button 
                                        onClick={handleFileUpload}
                                        disabled={!selectedFile || loading}
                                        className="upload-button"
                                    >
                                        {loading ? 'Loading...' : 'Upload CSV'}
                                    </button>
                                </div>
                            )}
                        </div>
                    </div>
                    
                    <div 
                        className={`data-source-option ${dataSource === 'api' ? 'selected' : ''}`}
                        onClick={() => setDataSource('api')}
                    >
                        <input 
                            type="radio" 
                            checked={dataSource === 'api'} 
                            onChange={() => setDataSource('api')}
                        />
                        <div>
                            <strong>Connect to C2 API (Dev Server)</strong>
                            <div>Use OAuth to connect to your Concept2 logbook (requires dev account)</div>
                            {dataSource === 'api' && !accessToken && (
                                <div className="file-upload">
                                    <a href={getAuthUrl()} className="auth-button">
                                        Connect to Concept2 Dev
                                    </a>
                                    <div style={{marginTop: '10px', fontSize: '12px', color: '#666'}}>
                                        Debug: After auth, check browser console (F12) for detailed logs
                                    </div>
                                </div>
                            )}
                            {accessToken && (
                                <div className="success">
                                    Connected to Concept2 API
                                </div>
                            )}
                        </div>
                    </div>

                    {message && (
                        <div className={message.includes('Error') || message.includes('Failed') ? 'error' : 'success'}>
                            {message}
                        </div>
                    )}
                </div>
            );
        }

        // Calendar component
        function Calendar({ workouts, userFTP, thresholdMethod, thresholdPace }) {
            const [currentDate, setCurrentDate] = useState(new Date());
            
            const currentMonth = currentDate.getMonth();
            const currentYear = currentDate.getFullYear();
            
            const firstDay = new Date(currentYear, currentMonth, 1);
            const lastDay = new Date(currentYear, currentMonth + 1, 0);
            const startDate = new Date(firstDay);
            startDate.setDate(startDate.getDate() - firstDay.getDay());
            
            const days = [];
            const current = new Date(startDate);
            
            for (let i = 0; i < 42; i++) {
                days.push(new Date(current));
                current.setDate(current.getDate() + 1);
            }
            
            const monthNames = [
                "January", "February", "March", "April", "May", "June",
                "July", "August", "September", "October", "November", "December"
            ];

            function goToPreviousMonth() {
                setCurrentDate(new Date(currentYear, currentMonth - 1, 1));
            }

            function goToNextMonth() {
                setCurrentDate(new Date(currentYear, currentMonth + 1, 1));
            }

            function goToToday() {
                setCurrentDate(new Date());
            }
            
            return (
                <div>
                    <div className="calendar-legend">
                        <div className="legend-title">Legend</div>
                        <div className="legend-row">
                            <strong>Circle Size (TSS):</strong>
                            <div className="legend-circles">
                                <div className="legend-circle" style={{width: 40, height: 40, backgroundColor: '#95a5a6'}}>25</div>
                                <div className="legend-circle" style={{width: 65, height: 65, backgroundColor: '#95a5a6'}}>50</div>
                                <div className="legend-circle" style={{width: 90, height: 90, backgroundColor: '#95a5a6'}}>75+</div>
                            </div>
                        </div>
                        <div className="legend-row">
                            <strong>Circle Color (IF):</strong>
                            <div className="legend-colors">
                                <div className="legend-color">
                                    <div className="legend-color-box" style={{backgroundColor: '#3498db'}}></div>
                                    <span>Easy (&lt;0.5)</span>
                                </div>
                                <div className="legend-color">
                                    <div className="legend-color-box" style={{backgroundColor: '#2ecc71'}}></div>
                                    <span>Moderate (0.5-0.7)</span>
                                </div>
                                <div className="legend-color">
                                    <div className="legend-color-box" style={{backgroundColor: '#f39c12'}}></div>
                                    <span>Hard (0.7-0.85)</span>
                                </div>
                                <div className="legend-color">
                                    <div className="legend-color-box" style={{backgroundColor: '#e67e22'}}></div>
                                    <span>Very Hard (0.85-1.0)</span>
                                </div>
                                <div className="legend-color">
                                    <div className="legend-color-box" style={{backgroundColor: '#e74c3c'}}></div>
                                    <span>Max (&gt;1.0)</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div className="calendar-nav">
                        <button className="nav-button" onClick={goToPreviousMonth}>
                            ← Previous
                        </button>
                        <h2>{monthNames[currentMonth]} {currentYear}</h2>
                        <div>
                            <button className="nav-button" onClick={goToToday} style={{marginRight: '10px'}}>
                                Today
                            </button>
                            <button className="nav-button" onClick={goToNextMonth}>
                                Next →
                            </button>
                        </div>
                    </div>

                    <div className="calendar-grid">
                        {['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].map(day => (
                            <div key={day} style={{background: '#f0f0f0', padding: '10px', fontWeight: 'bold', textAlign: 'center'}}>
                                {day}
                            </div>
                        ))}
                        {days.map((day, index) => {
                            const dayWorkouts = workouts.filter(w => {
                                const workoutDate = new Date(w.date);
                                return workoutDate.toDateString() === day.toDateString();
                            });
                            
                            // Combine multiple workouts on the same day
                            const combinedWorkout = dayWorkouts.length > 0 ? combineWorkoutsForDay(dayWorkouts) : null;
                            
                            return (
                                <div key={index} className="calendar-day">
                                    <div className="calendar-day-number">
                                        {day.getDate()}
                                    </div>
                                    {combinedWorkout && (() => {
                                        const tss = calculateTSS(combinedWorkout, userFTP, thresholdMethod, thresholdPace);
                                        const ifValue = calculateIF(combinedWorkout, userFTP, thresholdMethod, thresholdPace);
                                        
                                        // Scale diameter based on TSS (40-120px range for 30% larger circles)
                                        const diameter = Math.max(40, Math.min(120, 40 + (tss * 1.6)));
                                        const color = getIFColor(ifValue);
                                        
                                        return (
                                            <div
                                                className="workout-circle"
                                                style={{
                                                    width: diameter,
                                                    height: diameter,
                                                    backgroundColor: color,
                                                    top: '50%',
                                                    left: '50%',
                                                    transform: 'translate(-50%, -50%)',
                                                    fontSize: diameter < 40 ? '9px' : diameter < 60 ? '11px' : '13px',
                                                    flexDirection: 'column',
                                                    textAlign: 'center'
                                                }}
                                                title={`${combinedWorkout.workoutCount} workout${combinedWorkout.workoutCount > 1 ? 's' : ''} - TSS: ${tss}, IF: ${ifValue}, Distance: ${Math.round(combinedWorkout.distance)}m, Time: ${formatTime(combinedWorkout.time)}`}
                                            >
                                                <div style={{fontSize: diameter < 40 ? '9px' : diameter < 60 ? '11px' : '13px'}}>
                                                    {combinedWorkout.distance ? `${Math.round(combinedWorkout.distance)}m` : formatTime(combinedWorkout.time)}
                                                </div>
                                                <div className="workout-details" style={{fontSize: diameter < 40 ? '7px' : '8px', color: 'rgba(255,255,255,0.9)', textShadow: 'none'}}>
                                                    TSS:{tss} IF:{ifValue}
                                                    <br/>
                                                    {formatTime(combinedWorkout.time)}
                                                </div>
                                            </div>
                                        );
                                    })()}
                                </div>
                            );
                        })}
                    </div>
                </div>
            );
        }

        // Statistics component
        function Statistics({ workouts, userFTP, thresholdMethod, thresholdPace }) {
            const now = new Date();
            const oneWeekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
            const oneMonthAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
            const oneYearAgo = new Date(now.getTime() - 365 * 24 * 60 * 60 * 1000);
            
            function getStats(filterDate) {
                const filtered = workouts.filter(w => new Date(w.date) >= filterDate);
                const totalDistance = filtered.reduce((sum, w) => sum + (w.distance || 0), 0);
                const totalTime = filtered.reduce((sum, w) => sum + (w.time || 0), 0);
                const totalTSS = filtered.reduce((sum, w) => sum + calculateTSS(w, userFTP), 0);
                const avgPace = totalDistance > 0 ? (totalTime / (totalDistance / 500)) : 0;
                const avgIF = filtered.length > 0 ? 
                    filtered.reduce((sum, w) => sum + calculateIF(w, userFTP), 0) / filtered.length : 0;
                
                return {
                    distance: Math.round(totalDistance),
                    time: totalTime,
                    pace: avgPace,
                    workouts: filtered.length,
                    tss: totalTSS,
                    avgIF: Math.round(avgIF * 100) / 100
                };
            }
            
            const weeklyStats = getStats(oneWeekAgo);
            const monthlyStats = getStats(oneMonthAgo);
            const yearlyStats = getStats(oneYearAgo);
            
            return (
                <div className="stats-grid">
                    <div className="stats-card">
                        <div className="stats-title">Weekly Totals</div>
                        <div className="stats-value">{weeklyStats.distance.toLocaleString()}m</div>
                        <div className="stats-label">Distance</div>
                        <div className="stats-value">{formatTime(weeklyStats.time)}</div>
                        <div className="stats-label">Time</div>
                        <div className="stats-value">{formatPace(weeklyStats.pace)}</div>
                        <div className="stats-label">Avg Pace/500m</div>
                        <div className="stats-value">{weeklyStats.tss}</div>
                        <div className="stats-label">Total TSS</div>
                        <div className="stats-value">{weeklyStats.avgIF}</div>
                        <div className="stats-label">Avg IF</div>
                        <div className="stats-value">{weeklyStats.workouts}</div>
                        <div className="stats-label">Workouts</div>
                    </div>
                    
                    <div className="stats-card">
                        <div className="stats-title">Monthly Totals</div>
                        <div className="stats-value">{monthlyStats.distance.toLocaleString()}m</div>
                        <div className="stats-label">Distance</div>
                        <div className="stats-value">{formatTime(monthlyStats.time)}</div>
                        <div className="stats-label">Time</div>
                        <div className="stats-value">{formatPace(monthlyStats.pace)}</div>
                        <div className="stats-label">Avg Pace/500m</div>
                        <div className="stats-value">{monthlyStats.tss}</div>
                        <div className="stats-label">Total TSS</div>
                        <div className="stats-value">{monthlyStats.avgIF}</div>
                        <div className="stats-label">Avg IF</div>
                        <div className="stats-value">{monthlyStats.workouts}</div>
                        <div className="stats-label">Workouts</div>
                    </div>
                    
                    <div className="stats-card">
                        <div className="stats-title">Yearly Totals</div>
                        <div className="stats-value">{yearlyStats.distance.toLocaleString()}m</div>
                        <div className="stats-label">Distance</div>
                        <div className="stats-value">{formatTime(yearlyStats.time)}</div>
                        <div className="stats-label">Time</div>
                        <div className="stats-value">{formatPace(yearlyStats.pace)}</div>
                        <div className="stats-label">Avg Pace/500m</div>
                        <div className="stats-value">{yearlyStats.tss}</div>
                        <div className="stats-label">Total TSS</div>
                        <div className="stats-value">{yearlyStats.avgIF}</div>
                        <div className="stats-label">Avg IF</div>
                        <div className="stats-value">{yearlyStats.workouts}</div>
                        <div className="stats-label">Workouts</div>
                    </div>
                </div>
            );
        }

        // Main App component
        function App() {
            const [workouts, setWorkouts] = useState([]);
            const [dataSource, setDataSource] = useState(null);
            const [activeTab, setActiveTab] = useState('calendar');
            const [userFTP, setUserFTP] = useState(166);
            const [thresholdMethod, setThresholdMethod] = useState('pace');
            const [thresholdPace, setThresholdPace] = useState('2:34');
            
            function handleDataLoaded(workoutData, source) {
                setWorkouts(workoutData);
                setDataSource(source);
            }

            function handleFTPChange(newFTP) {
                setUserFTP(newFTP);
            }

            function handleThresholdMethodChange(method) {
                setThresholdMethod(method);
            }

            function handleThresholdPaceChange(pace) {
                setThresholdPace(pace);
            }
            
            if (workouts.length === 0) {
                return (
                    <div className="container">
                        <div className="header">
                            <h1>C2 Workout Tracker</h1>
                            <p>TSS & IF Analysis for Concept2 Workouts</p>
                        </div>
                        <DataSourceSelector 
                            onDataLoaded={handleDataLoaded}
                            onFTPChange={handleFTPChange}
                            userFTP={userFTP}
                            onThresholdMethodChange={handleThresholdMethodChange}
                            thresholdMethod={thresholdMethod}
                            onThresholdPaceChange={handleThresholdPaceChange}
                            thresholdPace={thresholdPace}
                        />
                    </div>
                );
            }
            
            return (
                <div className="container">
                    <div className="header">
                        <h1>C2 Workout Tracker</h1>
                        <p>{workouts.length} workouts loaded from {dataSource}</p>
                    </div>
                    
                    <div className="data-info">
                        Data source: {dataSource} | 
                        {thresholdMethod === 'watts' ? `FTP: ${userFTP}W` : `Threshold Pace: ${thresholdPace}`} | 
                        <button 
                            onClick={() => {setWorkouts([]); setDataSource(null);}}
                            style={{marginLeft: '10px', padding: '5px 10px', background: '#6c757d', color: 'white', border: 'none', borderRadius: '3px', cursor: 'pointer'}}
                        >
                            Change Data Source
                        </button>
                    </div>
                    
                    <div className="tabs">
                        <button 
                            className={`tab ${activeTab === 'calendar' ? 'active' : ''}`}
                            onClick={() => setActiveTab('calendar')}
                        >
                            Calendar View
                        </button>
                        <button 
                            className={`tab ${activeTab === 'stats' ? 'active' : ''}`}
                            onClick={() => setActiveTab('stats')}
                        >
                            Statistics
                        </button>
                    </div>
                    
                    <div className="content">
                        {activeTab === 'calendar' && <Calendar workouts={workouts} userFTP={userFTP} thresholdMethod={thresholdMethod} thresholdPace={thresholdPace} />}
                        {activeTab === 'stats' && <Statistics workouts={workouts} userFTP={userFTP} thresholdMethod={thresholdMethod} thresholdPace={thresholdPace} />}
                    </div>
                </div>
            );
        }

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>